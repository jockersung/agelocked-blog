---
import type { MarkdownHeading } from 'astro';

interface Props {
  headings: MarkdownHeading[];
}

const { headings } = Astro.props;
const filtered = headings.filter(h => h.depth === 2 || h.depth === 3);
---

{filtered.length > 0 && (
  <nav class="toc" id="toc">
    <button class="toc-toggle" id="toc-toggle" aria-expanded="true">
      <span class="toc-title">目錄</span>
      <svg class="toc-chevron" width="16" height="16" viewBox="0 0 16 16" fill="none">
        <path d="M4 6l4 4 4-4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </button>
    <ol class="toc-list" id="toc-list">
      {filtered.map(h => (
        <li class={`toc-item toc-depth-${h.depth}`}>
          <a href={`#${h.slug}`} class="toc-link" data-slug={h.slug}>
            {h.text}
          </a>
        </li>
      ))}
    </ol>
  </nav>
)}

<style>
  .toc {
    position: sticky;
    top: 80px;
    max-height: calc(100vh - 120px);
    overflow-y: auto;
    padding: 1.25rem 1.5rem;
    background: var(--bg2);
    border: 1px solid var(--border);
    border-radius: 8px;
    font-size: 0.85rem;
    scrollbar-width: thin;
  }

  .toc-toggle {
    display: flex;
    align-items: center;
    justify-content: space-between;
    width: 100%;
    background: none;
    border: none;
    padding: 0;
    cursor: pointer;
    color: var(--ink);
    margin-bottom: 0.75rem;
  }

  .toc-title {
    font-family: 'DM Mono', monospace;
    font-size: 0.72rem;
    letter-spacing: 0.2em;
    text-transform: uppercase;
    color: var(--muted);
  }

  .toc-chevron {
    color: var(--muted);
    transition: transform 0.2s;
    flex-shrink: 0;
  }

  .toc-toggle[aria-expanded="false"] .toc-chevron {
    transform: rotate(-90deg);
  }

  .toc-list {
    list-style: none;
    padding: 0;
    margin: 0;
    display: flex;
    flex-direction: column;
    gap: 0.1rem;
    overflow: hidden;
    transition: max-height 0.3s ease;
    max-height: 2000px;
  }

  .toc-list.collapsed {
    max-height: 0;
  }

  .toc-item { margin: 0; }

  .toc-depth-3 { padding-left: 1rem; }

  .toc-link {
    display: block;
    padding: 0.3rem 0.5rem;
    color: var(--muted);
    border-bottom: none;
    border-radius: 4px;
    line-height: 1.4;
    transition: background 0.15s, color 0.15s;
    text-decoration: none;
  }

  .toc-link:hover {
    color: var(--teal);
    background: var(--teal-pale);
    border-bottom: none;
  }

  .toc-link.active {
    color: var(--teal);
    background: var(--teal-pale);
    font-weight: 500;
  }

  /* Inline mode for narrow screens */
  @media (max-width: 1100px) {
    .toc {
      position: static;
      max-height: none;
      margin-bottom: 2rem;
    }
  }
</style>

<script>
  const toggle = document.getElementById('toc-toggle');
  const list = document.getElementById('toc-list');

  // Default collapsed on mobile
  if (window.innerWidth <= 640 && toggle && list) {
    toggle.setAttribute('aria-expanded', 'false');
    list.classList.add('collapsed');
  }

  toggle?.addEventListener('click', () => {
    const expanded = toggle.getAttribute('aria-expanded') === 'true';
    toggle.setAttribute('aria-expanded', String(!expanded));
    list?.classList.toggle('collapsed', expanded);
  });

  // IntersectionObserver highlight
  const links = document.querySelectorAll<HTMLAnchorElement>('.toc-link');
  const slugToLink = new Map<string, HTMLAnchorElement>();
  links.forEach(link => {
    const slug = link.dataset.slug;
    if (slug) slugToLink.set(slug, link);
  });

  const headingEls = Array.from(
    document.querySelectorAll<HTMLElement>('article h2[id], article h3[id]')
  );

  if (headingEls.length > 0) {
    let activeSlug = '';

    const observer = new IntersectionObserver(
      entries => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            activeSlug = entry.target.id;
          }
        });
        slugToLink.forEach((link, slug) => {
          link.classList.toggle('active', slug === activeSlug);
        });
      },
      { rootMargin: '0px 0px -60% 0px', threshold: 0 }
    );

    headingEls.forEach(el => observer.observe(el));
  }
</script>
